@page "/containers"
@using ApiContracts
@using WoM_BlazorApp.Services.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@inject IContainerService ContainerService
@inject AuthenticationStateProvider AuthStateProvider

<h3>Containers</h3>

@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<div class="card p-3 mb-3">
    <h5>Add Container</h5>
    <input class="form-control mb-2" type="number" step="0.1" @bind="_capacity" />
    <button class="btn btn-primary" @onclick="Create">Create</button>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Id</th>
            <th>Capacity</th>
            <th>Occupied</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var c in _containers)
        {
            <tr>
                <td>@c.Id</td>
                <td>@c.CapacityL</td>
                <td>@c.OccupiedCapacityL</td>
                <td>
                    <button class="btn btn-danger btn-sm"
                            disabled="@(!_isOwner)"
                            @onclick="() => Delete(c.Id)">
                        Delete
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    private readonly List<ContainerDto> _containers = new();
    private string? _error;
    private bool _isOwner;
    private double _capacity;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        _isOwner = auth.User.IsInRole("Owner");

        await Reload();
    }

    private async Task Reload()
    {
        var list = await ContainerService.GetAllAsync();
        _containers.Clear();
        _containers.AddRange(list.Containers);
    }

    private async Task Create()
    {
        try
        {
            await ContainerService.CreateAsync(new CreateContainerDto { CapacityL = _capacity });
            await Reload();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task Delete(long id)
    {
        if (!_isOwner) return;

        await ContainerService.DeleteAsync(id);
        await Reload();
    }
}
