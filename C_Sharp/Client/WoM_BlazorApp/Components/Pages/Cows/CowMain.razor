@page "/cows"
@rendermode InteractiveServer

@using ApiContracts
@using WoM_BlazorApp.Services.Interfaces
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@inject ICowService CowService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

@attribute [Authorize]

<PageTitle>Cows</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Cows</h1>
    @if (isOwner)
    {
        <button class="btn btn-primary" @onclick="@(() => Nav.NavigateTo("/cows/create"))">
            + Add new cow
        </button>
    }
</div>

<div class="card bg-light mb-4">
    <div class="card-body py-2">
        <div class="row g-2 align-items-center">
            <div class="col-auto">
                <label class="col-form-label fw-bold">Filter by Department:</label>
            </div>
            <div class="col-auto">
                <input type="number" class="form-control" @bind="searchDeptId" placeholder="Dept ID..." />
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" @onclick="FilterByDept">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
            @if (isFiltered)
            {
                <div class="col-auto">
                    <button class="btn btn-outline-secondary" @onclick="ClearFilter">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="spinner-border text-primary"></div>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger alert-dismissible fade show">
        @error
        <button type="button" class="btn-close" @onclick="() => error = null"></button>
    </div>
}
else if (cows is null || !cows.Any())
{
    <p>No cows yet.</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Reg No</th>
                    <th>Birth Date</th>
                    <th>Health</th>
                    <th>Department</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cow in cows)
                {
                    <tr>
                        <td>@cow.RegNo</td>
                        <td>@cow.BirthDate.ToString("yyyy-MM-dd")</td>
                        <td>
                            @if (cow.Healthy)
                            {
                                <span class="badge bg-success">Healthy</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Suspect</span>
                            }
                        </td>
                        <td>
                            @* Show Name if it exists *@
                            @if (!string.IsNullOrEmpty(cow.DepartmentName))
                            {
                                <span>@cow.DepartmentName</span>
                            }

                            @* Show ID if it exists *@
                            @if (cow.DepartmentId != null)
                            {
                                @* Add a space if we also showed the name *@
                                @if (!string.IsNullOrEmpty(cow.DepartmentName))
                                {
                                    <text> </text>
                                }
                                <span class="badge bg-secondary text-white ms-1">@cow.DepartmentId</span>
                            }

                            @* Fallback if both are missing *@
                            @if (string.IsNullOrEmpty(cow.DepartmentName) && cow.DepartmentId == null)
                            {
                                <span>-</span>
                            }
                        </td>
                        <td>
                            <div class="d-flex gap-1 flex-wrap">
                                @* 1. TRANSFER (Visible to All) *@
                                <button class="btn btn-outline-secondary" @onclick="@(() => Nav.NavigateTo("/transfer-records/create"))">
                                    <i class="bi bi-arrow-left-right"></i> Transfer
                                </button>

                                @* 2. HEALTH CONTROLS *@
                                @if (cow.Healthy)
                                {
                                    @* Anyone can mark as Suspect *@
                                    <button class="btn btn-outline-warning"
                                            @onclick="@(() => UpdateHealth(cow, false))">
                                        Mark Suspect
                                    </button>
                                }
                                else
                                {
                                    @* Only Vets can mark as healthy *@
                                    @if (isVet)
                                    {
                                        <button class="btn btn-outline-success"
                                                @onclick="@(() => UpdateHealth(cow, true))">
                                            Mark Healthy
                                        </button>
                                    }
                                }
                                @* add milk collection button -- ADD navigation when ready *@
                                <button class="btn btn-outline-primary" @onclick="@(() => Nav.NavigateTo($"#"))">
                                    Add Milk
                                </button>

                                @* find milk from cow -- ADD navigation when ready*@
                                <button class="btn btn-outline-primary" @onclick="@(() => Nav.NavigateTo($"#"))">
                                    Milk History
                                </button>

                                @* 3. OWNER ACTIONS *@
                                @if (isOwner)
                                {
                                    <button class="btn btn-primary"
                                            @onclick="@(() => Nav.NavigateTo($"/cows/edit/{cow.Id}"))">
                                        Edit
                                    </button>
                                    <button class="btn btn-danger"
                                            @onclick="@(() => DeleteAsync(cow.Id))">
                                        Delete
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
        private bool isLoading = true;
        private string? error;
        private IEnumerable<CowDto>? cows;

        // Permission Flags
        private bool isOwner = false;
        private bool isVet = false;

        //Filter logic
        private long? searchDeptId;
        private bool isFiltered = false;

        protected override async Task OnInitializedAsync()
        {
                await LoadCows();
        }


        private async Task LoadCows()
        {
            isLoading = true;
            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                isOwner = authState.User.IsInRole("Owner");
                isVet = authState.User.IsInRole("Vet");

                // Default load: All cows
                cows = await CowService.GetAllAsync();
                isFiltered = false;
            }
            catch (Exception e)
            {
                error = e.Message;
            }
            finally
            {
                isLoading = false;
            }
        }

        private async Task UpdateHealth(CowDto cow, bool newStatus)
        {
            try
            {
                // Update on server
                await CowService.UpdateHealthAsync(new[] { cow.Id }, newStatus);
                // Update locally to refresh UI instantly
                cow.Healthy = newStatus;
            }
            catch (Exception ex)
            {
                error = $"Failed to update health: {ex.Message}";
            }
        }
        private async Task FilterByDept()
        {
            if (searchDeptId == null || searchDeptId <= 0) return;

            isLoading = true;
            try
            {
                cows = await CowService.GetCowsByDepartmentAsync(searchDeptId.Value);
                isFiltered = true;
                error = null;
            }
            catch (Exception e)
            {
                error = $"Failed to find department: {e.Message}";
                cows = new List<CowDto>(); // Show empty list on error
            }
            finally
            {
                isLoading = false;
            }
        }

        private async Task ClearFilter()
        {
            searchDeptId = null;
            await LoadCows(); // Reload all
        }

        private async Task DeleteAsync(long id)
        {
            if (!await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this cow?"))
                return;

            error = null;
            try
            {
                await CowService.DeleteAsync(id);
                cows = await CowService.GetAllAsync();
            }
            catch (Exception e)
            {
                error = e.Message;
            }
        }

        private async Task TransferCow()
        {
            await JS.InvokeVoidAsync("alert", "Transfer functionality is coming soon!");
        }
    }
}
