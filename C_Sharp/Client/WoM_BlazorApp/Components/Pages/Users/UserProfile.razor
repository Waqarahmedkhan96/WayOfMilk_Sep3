@using ApiContracts
@using WoM_BlazorApp.Services.Interfaces
@using System.Text.Json
@using System.Text.Json.Serialization

@inject IUserService UserService
@inject NavigationManager Nav

<div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h3 class="mb-0">My Profile</h3>
        @if (!isEditing && UserDto != null)
        {
            <span class="badge bg-secondary">@UserDto.Role</span>
        }
    </div>
    <div class="card-body">
        @if (UserDto == null)
        {
            <p>Loading profile...</p>
        }
        else
        {
            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert alert-success">@message</div>
            }
            @if (!string.IsNullOrEmpty(error))
            {
                <div class="alert alert-danger">@error</div>
            }

            <EditForm Model="UserDto" OnValidSubmit="UpdateProfile">
                <DataAnnotationsValidator />

                <fieldset disabled="@(!isEditing)">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Name</label>
                            <InputText @bind-Value="UserDto.Name" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <InputText @bind-Value="UserDto.Email" class="form-control" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <InputText @bind-Value="UserDto.Phone" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Address</label>
                            <InputText @bind-Value="UserDto.Address" class="form-control" />
                        </div>
                    </div>
                </fieldset>

                @* Role is always disabled, outside the fieldset to allow specific styling if needed *@
                <div class="mb-3">
                    <label class="form-label text-muted">Role (Read Only)</label>
                    <input type="text" class="form-control" value="@UserDto.Role" disabled />
                </div>

                <hr />

                @* BUTTON LOGIC *@
                @if (!isEditing)
                {
                    <div class="d-grid gap-2 col-md-8 mx-auto">

                        <button type="button" class="btn btn-primary" @onclick="EnableEditing">
                            <i class="bi bi-pencil"></i> Edit Profile
                        </button>

                        <button type="button" class="btn btn-outline-warning"
                                @onclick="@(() => Nav.NavigateTo("/change-password"))">
                            <i class="bi bi-key"></i> Change Password
                        </button>
                    </div>
                }
                else
                {
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" @onclick="CancelEditing">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-success">
                            Save Changes
                        </button>
                    </div>
                }

            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter]
    public UserDto? UserDto { get; set; }

    private bool isEditing = false;
    private string? message;
    private string? error;

    // We store a backup copy to revert changes if the user clicks "Cancel"
    private UserDto? _backupUser;

    private void EnableEditing()
    {
        if (UserDto == null) return;

        // Create a shallow copy of the current data before editing
        _backupUser = new UserDto
        {
            Id = UserDto.Id,
            Name = UserDto.Name,
            Email = UserDto.Email,
            Phone = UserDto.Phone,
            Address = UserDto.Address,
            Role = UserDto.Role
        };

        isEditing = true;
        message = null; // Clear old messages
        error = null;
    }

    private void CancelEditing()
    {
        if (UserDto != null && _backupUser != null)
        {
            // Revert changes
            UserDto.Name = _backupUser.Name;
            UserDto.Email = _backupUser.Email;
            UserDto.Phone = _backupUser.Phone;
            UserDto.Address = _backupUser.Address;
        }
        isEditing = false;
    }

    private async Task UpdateProfile()
    {
        message = null;
        error = null;
        try
        {
            if (UserDto == null) return;

            var updateDto = new UpdateUserDto
            {
                Id = UserDto.Id,
                Name = UserDto.Name,
                Email = UserDto.Email,
                Phone = UserDto.Phone,
                Address = UserDto.Address,
            };

            await UserService.UpdateProfileAsync(updateDto);

            message = "Profile updated successfully!";
            isEditing = false; // Turn off edit mode on success
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }
}