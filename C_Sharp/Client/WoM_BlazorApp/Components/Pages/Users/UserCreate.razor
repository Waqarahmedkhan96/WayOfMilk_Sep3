@page "/users/create"
@rendermode InteractiveServer

@using System
@using ApiContracts
@using WoM_BlazorApp.Services.Interfaces
@using Microsoft.AspNetCore.Authorization

@inject IUserService UserService
@inject NavigationManager Nav

@* Security: Only Owners can see this page *@
@attribute [Authorize(Roles = "Owner")]

<PageTitle>Add User</PageTitle>

<div class="container mt-4">
    <h1>Add new user</h1>

    <div class="row">
        @* Left Column *@
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Name</label>
                <InputText @bind-Value="name" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Email</label>
                <InputText @bind-Value="email" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Password</label>
                <InputText @bind-Value="password" type="password" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Role</label>
                <InputSelect @bind-Value="role" class="form-control">
                    @foreach (UserRole r in Enum.GetValues(typeof(UserRole)))
                    {
                        <option value="@r">@r.ToString()</option>
                    }
                </InputSelect>
            </div>
        </div>

        @* Right Column *@
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Phone</label>
                <InputText @bind-Value="phone" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Address</label>
                <InputText @bind-Value="address" class="form-control" />
            </div>

            @* License Number (Relevant mostly for Vets) *@
            <div class="mb-3">
                <label class="form-label">License Number (Vets only)</label>
                <InputText @bind-Value="licenseNumber" class="form-control"
                           placeholder="Optional" />
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger mt-3">@error</div>
    }

    <div class="mt-4">
        <button class="btn btn-success" @onclick="CreateAsync">Save</button>
        <button class="btn btn-secondary ms-2" @onclick="@(() => Nav.NavigateTo("/users"))">
            Cancel
        </button>
    </div>
</div>

@code {
    private string name = "";
    private string email = "";
    private string password = "";
    private string phone = "";
    private string address = "";
    private UserRole role = UserRole.Worker; // Default to Worker
    private string licenseNumber = "";
    private string? error;

    private async Task CreateAsync()
    {
        error = null;
        try
        {
            var dto = new CreateUserDto()
            {
                Name = name,
                Email = email,
                Phone = phone,
                Password = password,
                Role = role,
                Address = address,
                LicenseNumber = licenseNumber
            };

            // The UserService already handles the Enum serialization internally
            // because we updated the UserServiceImpl earlier.
            await UserService.CreateAsync(dto);
            Nav.NavigateTo("/users");
        }
        catch (Exception e)
        {
            error = e.Message;
        }
    }
}