@page "/users"
@rendermode InteractiveServer

@using ApiContracts
@using WoM_BlazorApp.Services.Interfaces
@using Microsoft.AspNetCore.Authorization

@inject IUserService UserService
@inject NavigationManager Nav

@* Security: Only Owners can see this page *@
@attribute [Authorize(Roles = "Owner")]

<PageTitle>Users</PageTitle>

<h1>Users</h1>

<button class="btn btn-primary mb-3"
        @onclick="@(() => Nav.NavigateTo("/users/create"))">
    + Add new user
</button>

@* State Handling (Loading -> Error -> Empty -> Data) *@
@if (isLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @error
    </div>
}
else if (users is null || !users.Any())
{
    <div class="alert alert-info">No users found in the system.</div>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in users)
            {
                <tr>
                    <td>@user.Id</td>
                    <td>@user.Name</td>
                    <td>@user.Email</td>
                    <td>
                        @* Display badge based on role *@
                        <span class="badge @GetRoleBadgeClass(user.Role)">
                            @user.Role
                        </span>
                    </td>
                    <td>
                        @* 5. Delete Button *@
                        <button class="btn btn-sm btn-outline-danger"
                                @onclick="() => DeleteAsync(user.Id)"
                                title="Delete User">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    // State variables
    private bool isLoading = true;
    private string? error;

    private IEnumerable<UserDto>? users;

    // Lifecycle Method: Runs when page loads
    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            isLoading = true;
            users = await UserService.GetAllAsync();
            error = null; // Clear error if successful
        }
        catch (Exception e)
        {
            error = e.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    // Event Handler: Delete
    private async Task DeleteAsync(long id)
    {
        // Simple confirmation logic could go here (requires JS interop),
        // but for now we just delete.
        try
        {
            await UserService.DeleteAsync(id);
            // Refresh list to show it's gone
            await LoadUsers();
        }
        catch (Exception e)
        {
            error = $"Failed to delete: {e.Message}";
        }
    }

    // UI Helper for styling badges
    private string GetRoleBadgeClass(UserRole role) => role switch
    {
        UserRole.Owner => "bg-danger",   // Red
        UserRole.Vet => "bg-success",    // Green
        _ => "bg-secondary"              // Grey (Worker)
    };
}
