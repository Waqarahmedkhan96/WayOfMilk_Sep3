@page "/milk"
@using ApiContracts
@using Microsoft.AspNetCore.Components.Authorization
@using WoM_BlazorApp.Services.Interfaces

@inject IMilkService MilkService
@inject AuthenticationStateProvider AuthStateProvider

<h3>Milk Records</h3>

@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<div class="card p-3 mb-3">
    <h5>Add Milk</h5>

    <div class="row g-2">
        <input class="form-control col" placeholder="CowId" type="number" @bind="_cowId" />
        <input class="form-control col" placeholder="ContainerId" type="number" @bind="_containerId" />
        <input class="form-control col" placeholder="Volume (L)" type="number" step="0.1" @bind="_volume" />

        <select class="form-select col" @bind="_testResult">
            @foreach (var v in Enum.GetValues<MilkTestResult>())
            {
                <option value="@v">@v</option>
            }
        </select>

        <button class="btn btn-primary col" @onclick="Create">Create</button>
    </div>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Id</th>
            <th>Cow</th>
            <th>Container</th>
            <th>Volume</th>
            <th>Test</th>
            <th>Approved</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var m in _milks)
        {
            <tr>
                <td>@m.Id</td>
                <td>@m.CowId</td>
                <td>@m.ContainerId</td>
                <td>@m.VolumeL</td>
                <td>@m.TestResult</td>
                <td>@m.ApprovedForStorage</td>
                <td>
                    <button class="btn btn-danger btn-sm"
                            disabled="@(!_isOwner)"
                            @onclick="() => Delete(m.Id)">
                        Delete
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    private readonly List<MilkDto> _milks = new();
    private string? _error;
    private bool _isOwner;

    private long _cowId;
    private long _containerId;
    private double _volume;
    private MilkTestResult _testResult = MilkTestResult.Pass;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        _isOwner = auth.User.IsInRole("Owner");

        await Reload();
    }

    private async Task Reload()
    {
        var list = await MilkService.GetAllAsync();
        _milks.Clear();
        _milks.AddRange(list.Milks);
    }

    private async Task Create()
    {
        try
        {
            await MilkService.CreateAsync(new CreateMilkDto
            {
                CowId = _cowId,
                ContainerId = _containerId,
                VolumeL = _volume,
                TestResult = _testResult,
                RegisteredByUserId = 0 // backend overrides if needed
            });

            await Reload();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task Delete(long id)
    {
        if (!_isOwner) return;

        await MilkService.DeleteAsync(id);
        await Reload();
    }
}
