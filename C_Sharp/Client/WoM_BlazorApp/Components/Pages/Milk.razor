@page "/milk"
@attribute [Authorize(Roles = "Owner,Worker")]
@using ApiContracts
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject WoM_BlazorApp.Services.Interfaces.IMilkService MilkService

<AuthorizeView Roles="Owner,Worker">
    <Authorized>
        <h3>Milk records</h3>

        <div class="mb-3 d-flex gap-2 align-items-end">
            <div>
                <label class="form-label">Container Id</label>
                <input type="number" class="form-control" @bind="filterContainerId" />
            </div>
            <div>
                <label class="form-label">Only approved</label>
                <input type="checkbox" class="form-check-input ms-1" @bind="filterApprovedOnly" />
            </div>
            <button class="btn btn-primary" @onclick="Reload">Reload</button>
        </div>

        <table class="table table-striped table-sm">
            <thead>
            <tr>
                <th>Id</th>
                <th>Date</th>
                <th>Volume</th>
                <th>Test</th>
                <th>Cow</th>
                <th>Container</th>
                <th>Approved</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            @foreach (var m in filteredMilk)
            {
                <tr>
                    <td>@m.Id</td>
                    <td>@m.Date</td>
                    <td>@m.VolumeL</td>
                    <td>@m.TestResult</td>
                    <td>@m.CowId</td>
                    <td>@m.ContainerId</td>
                    <td>@m.ApprovedForStorage</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => StartEdit(m)">Edit</button>
                        <button class="btn btn-sm btn-outline-success me-1" @onclick="() => ToggleApprove(m)">
                            @(m.ApprovedForStorage ? "Unapprove" : "Approve")
                        </button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(m.Id)">Delete</button>
                    </td>
                </tr>
            }
            </tbody>
        </table>

        <hr/>

        <h4>@(isEditing ? "Edit Milk" : "Create Milk")</h4>

        <div class="row g-2">
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" @bind="editDate" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Volume L</label>
                <input type="number" class="form-control" @bind="editVolume" step="0.1" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Cow Id</label>
                <input type="number" class="form-control" @bind="editCowId" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Container Id</label>
                <input type="number" class="form-control" @bind="editContainerId" />
            </div>
            <div class="col-md-3">
                <label class="form-label">RegisteredBy UserId</label>
                <input type="number" class="form-control" @bind="editRegisteredByUserId" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Test Result</label>
                <select class="form-select" @bind="editTestResult">
                    @foreach (MilkTestResult value in Enum.GetValues(typeof(MilkTestResult)))
                    {
                        <option value="@value">@value</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Approved?</label><br/>
                <input type="checkbox" class="form-check-input" @bind="editApprovedForStorage" />
            </div>
        </div>

        <button class="btn btn-success mt-3" @onclick="Save">
            @(isEditing ? "Save changes" : "Create")
        </button>
        @if (isEditing)
        {
            <button class="btn btn-secondary mt-3 ms-2" @onclick="CancelEdit">Cancel</button>
        }
    </Authorized>
    <NotAuthorized>
        <p>You must be logged in as Owner or Worker.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private MilkListDto milkList = new();                    // all milk
    private IEnumerable<MilkDto> filteredMilk => Apply();    // filtered

    private long? filterContainerId;                         // filter id
    private bool filterApprovedOnly;                         // filter flag

    private bool isEditing;                                  // edit flag
    private long editingId;                                  // edit id
    private DateTime editDate = DateTime.Today;              // edit date
    private double editVolume;                               // edit volume
    private long editCowId;                                  // edit cow
    private long editContainerId;                            // edit container
    private long editRegisteredByUserId;                     // edit user
    private MilkTestResult editTestResult = MilkTestResult.Pass; // edit test
    private bool editApprovedForStorage;                     // edit approved

    protected override async Task OnInitializedAsync()
    {
        await Reload(); // initial load
    }

    private async Task Reload()
    {
        // load list
        if (filterContainerId.HasValue && filterContainerId.Value > 0)
            milkList = await MilkService.GetByContainerAsync(filterContainerId.Value);
        else
            milkList = await MilkService.GetAllAsync();
    }

    private IEnumerable<MilkDto> Apply()
    {
        // apply filters
        var query = milkList.Milks.AsEnumerable();
        if (filterApprovedOnly)
            query = query.Where(m => m.ApprovedForStorage);
        return query;
    }

    private void StartEdit(MilkDto m)
    {
        // fill form
        isEditing = true;
        editingId = m.Id;
        editDate = m.Date.ToDateTime(TimeOnly.MinValue);
        editVolume = m.VolumeL;
        editCowId = m.CowId;
        editContainerId = m.ContainerId;
        editRegisteredByUserId = m.RegisteredByUserId;
        editTestResult = m.TestResult;
        editApprovedForStorage = m.ApprovedForStorage;
    }

    private void CancelEdit()
    {
        // cancel edit
        isEditing = false;
        editingId = 0;
        editApprovedForStorage = false;
    }

    private async Task Save()
    {
        if (!isEditing)
        {
            // create
            var dto = new CreateMilkDto
            {
                Date = DateOnly.FromDateTime(editDate),
                VolumeL = editVolume,
                CowId = editCowId,
                ContainerId = editContainerId,
                RegisteredByUserId = editRegisteredByUserId,
                TestResult = editTestResult,
                ApprovedForStorage = editApprovedForStorage
            };
            await MilkService.CreateAsync(dto);
        }
        else
        {
            // update
            var dto = new UpdateMilkDto
            {
                Date = DateOnly.FromDateTime(editDate),
                VolumeL = editVolume,
                ContainerId = editContainerId,
                TestResult = editTestResult,
                ApprovedForStorage = editApprovedForStorage
            };
            await MilkService.UpdateAsync(editingId, dto);
        }

        isEditing = false;
        await Reload();
    }

    private async Task ToggleApprove(MilkDto m)
    {
        // flip approve
        await MilkService.ApproveAsync(m.Id, !m.ApprovedForStorage);
        await Reload();
    }

    private async Task Delete(long id)
    {
        // delete row
        await MilkService.DeleteAsync(id);
        await Reload();
    }
}
